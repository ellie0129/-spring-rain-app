# spring_rain_app.py (ìµœì¢… ì™„ì„±ë³¸)
# ì™„ì „íˆ í†µí•©ëœ Streamlit ì•± ì½”ë“œ: ëª¨ë“  ìš”ì²­ì‚¬í•­ ë°˜ì˜

import streamlit as st
import numpy as np
import plotly.graph_objects as go

st.set_page_config(page_title="ë´„ë¹„ ì ìˆ˜ ë¶„ì„ê¸°", page_icon="ğŸŒ±", layout="wide")

st.title("ğŸŒ§ï¸ ë´„ë¹„(Spring Rain) ì ìˆ˜ ë¶„ì„ê¸°")
st.caption("ì„œìš¸ì‹œë¦½ëŒ€í•™êµ | ì´ì¶˜ìš° êµìˆ˜ë‹˜ì˜ ê¸°ì—…ê°€ì •ì‹  í†µí•©ëª¨í˜• ê¸°ë°˜")

menu = st.sidebar.radio("ë©”ë‰´", ["ë¶„ì„ê¸°", "ëª¨í˜• ì„¤ëª…"])

# ---------------- ëª¨í˜• ì„¤ëª… íƒ­ ----------------
if menu == "ëª¨í˜• ì„¤ëª…":
    st.header("ğŸ“˜ ê¸°ì—…ê°€ì •ì‹  í†µí•©ëª¨í˜• êµ¬ì¡° ì„¤ëª…")
    st.markdown("""
    ### ğŸŒŸ Outcome Layer (2ê°€ì§€)
    - ë¶€ì˜ ì¦ëŒ€ (Wealth Creation)
    - ê°€ì¹˜ ì°½ì¶œ (Value Creation)

    ### ğŸ¯ Mission Layer (4ê°€ì§€)
    - ê¸°íšŒì¶”êµ¬ (Opportunity Seeking)
    - ê³µë™ì²´ ë°œì „ (Community Development)
    - ì°½ì¡°ì  íŒŒê´´ (Creative Destruction)
    - ë¯¸ë˜ì§€í–¥ (Future Orientation)

    ### ğŸŒ€ Attitude Layer (8ê°€ì§€)
    - ì°½ì¡° Â· ë°œëª… Â· ê°œë°œ
    - ì¡°í•© Â· ì¤‘ê°œ
    - í˜ì‹  Â· ë³€í™” Â· ê°œì„ 
    - ë„ì „ Â· ê·¹ë³µ
    - ì£¼ë„ Â· ì‚¬ì—…í™”
    - ì—­ë°œìƒ Â· ì¬í•´ì„
    - ê°œì²™ Â· íƒí—˜ Â· ëª¨í—˜
    - ë°œê²¬ Â· ë°œìƒ Â· ìƒìƒ

    ### ğŸ§¬ Competence Layer (8ê°€ì§€)
    - ğŸ’ª ë„ì „ì •ì‹ : ìê¸°íš¨ëŠ¥ê°, ì„±ì·¨ìš•êµ¬, í—ê·¸ë¦¬ì •ì‹ 
    - ğŸ’¡ ìµœê³ Â·ìµœì´ˆÂ·ìµœì‹ Â·ìœ ì¼ ì§€í–¥: ì—´ë§, ì‹¤í–‰ë ¥, ê²°ë‹¨ë ¥, ê³ ìˆ˜ìµ ê¸°ëŒ€
    - ğŸ§­ Integrity: ë¦¬ë”ì‹­, ì‚¬ì—…ìˆ˜ì™„, ê²½ì˜ì—­ëŸ‰, ì‹ ìš©, ê·¼ë©´ì„±ì‹¤
    - ğŸ” ì°½ì¡°ì  ë¬¸ì œí•´ê²°: ë‚™ê´€ì„±, í†µì°°ë ¥, ì•„ì´ë””ì–´, ì¸ì§€ëŠ¥ë ¥
    - ğŸŒ± ë…ë¦½ì„±Â·ìê¸°ê³ ìš©: ìì•„ì‹¤í˜„, ììœ¨ì„±, ìˆœì‘ê±°ë¶€, ì—­ê²½ ê·¹ë³µ
    - ğŸš€ ì§„ì·¨ì„±(ì„ ë„ì„±): ì—´ì •, ëª¨í˜¸ì„± ì¸ë‚´ë„, ê³µê²©ì„±, ì„ ë„ë ¥
    - ğŸ›¡ ìœ„í—˜ê°ìˆ˜ì„±: ì¸ë‚´ì‹¬, ìœ„í—˜ì„ í˜¸, CSR/CSV, ì±…ì„ê°
    - ğŸ”„ í˜ì‹ ì„±: ê¸°ì—…ìœ¤ë¦¬, ì°½ì˜ì„±, í˜ì‹  ìˆ˜ìš©ì„±

    ---

    ### ğŸ–¼ï¸ í†µí•©ëª¨í˜• ì‹œê° ìë£Œ
    ![í†µí•©ëª¨í˜• ì´ë¯¸ì§€](https://raw.githubusercontent.com/ellie0129/spring-rain-app/main/assets/1ce34f642e1b80808f4edd8cc64b1a95.png)
    """)

# ---------------- ë¶„ì„ê¸° íƒ­ ----------------
else:
    st.subheader("ğŸ¤– AI ê¸°ë°˜ ì¸ë¬¼ ë¶„ì„")
    st.caption("ì˜ˆì‹œ: ì œí”„ ë² ì¡°ìŠ¤, ê¹€ìŠ¬ì•„, ì •ì£¼ì˜")

    selected_name = st.text_input("ë¶„ì„í•  ì¸ë¬¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”")

    # ìƒ˜í”Œ í”„ë¡œí•„ ì •ì˜
    sample_profiles = {
        "ì œí”„ ë² ì¡°ìŠ¤": ([
            ("ë„ì „ì •ì‹ ", [1.0, 0.9, 0.9]),
            ("ìµœê³ Â·ìµœì´ˆÂ·ìµœì‹ Â·ìœ ì¼ ì§€í–¥", [0.9, 0.9, 0.95, 0.9]),
            ("Integrity", [0.85, 0.85, 0.9, 0.85, 0.9]),
            ("ì°½ì¡°ì  ë¬¸ì œí•´ê²°", [0.95, 0.9, 0.9, 0.9]),
            ("ë…ë¦½ì„± Â· ìê¸°ê³ ìš© Â· ìê¸°ì„¸ê³„", [0.9, 0.9, 0.85, 0.9]),
            ("ì§„ì·¨ì„±(ì„ ë„ì„±)", [0.95, 0.95, 0.9, 0.95]),
            ("ìœ„í—˜ê°ìˆ˜ì„±", [0.9, 0.9, 0.9, 0.95]),
            ("í˜ì‹ ì„±", [0.95, 0.95, 0.95])
        ], "ì•„ë§ˆì¡´ ì°½ë¦½ì ì œí”„ ë² ì¡°ìŠ¤ëŠ” í˜ì‹ ì„±ê³¼ ì§„ì·¨ì„± ë©´ì—ì„œ íƒ€ì˜ ì¶”ì¢…ì„ ë¶ˆí—ˆí•˜ë©°, ë¬¸ì œ í•´ê²°ë ¥ê³¼ ì¶”ì§„ë ¥, ë„ì „ì •ì‹ ì—ì„œ ë§¤ìš° ë†’ì€ ì—­ëŸ‰ì„ ë³´ì…ë‹ˆë‹¤."),

        "ê¹€ìŠ¬ì•„": ([
            ("ë„ì „ì •ì‹ ", [0.9, 0.85, 0.85]),
            ("ìµœê³ Â·ìµœì´ˆÂ·ìµœì‹ Â·ìœ ì¼ ì§€í–¥", [0.85, 0.85, 0.9, 0.85]),
            ("Integrity", [0.85, 0.85, 0.85, 0.85, 0.85]),
            ("ì°½ì¡°ì  ë¬¸ì œí•´ê²°", [0.9, 0.9, 0.85, 0.9]),
            ("ë…ë¦½ì„± Â· ìê¸°ê³ ìš© Â· ìê¸°ì„¸ê³„", [0.85, 0.85, 0.8, 0.85]),
            ("ì§„ì·¨ì„±(ì„ ë„ì„±)", [0.9, 0.9, 0.9, 0.9]),
            ("ìœ„í—˜ê°ìˆ˜ì„±", [0.8, 0.8, 0.8, 0.9]),
            ("í˜ì‹ ì„±", [0.9, 0.9, 0.95])
        ], "ë§ˆì¼“ì»¬ë¦¬ë¥¼ ì°½ì—…í•œ ê¹€ìŠ¬ì•„ ëŒ€í‘œëŠ” ê³ ìœ„í—˜ì„ ê°ìˆ˜í•˜ë©° ìƒˆë¡œìš´ ë¬¼ë¥˜ íŒ¨ëŸ¬ë‹¤ì„ì„ ì œì‹œí–ˆê³ , ì‹¤í–‰ë ¥ê³¼ í˜ì‹  ìˆ˜ìš©ì„±ì—ì„œ ë‘ê°ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤."),

        "ì •ì£¼ì˜": ([
            ("ë„ì „ì •ì‹ ", [1.0, 0.95, 0.95]),
            ("ìµœê³ Â·ìµœì´ˆÂ·ìµœì‹ Â·ìœ ì¼ ì§€í–¥", [0.95, 0.95, 0.9, 0.95]),
            ("Integrity", [0.9, 0.9, 0.9, 0.95, 0.95]),
            ("ì°½ì¡°ì  ë¬¸ì œí•´ê²°", [0.9, 0.9, 0.9, 0.9]),
            ("ë…ë¦½ì„± Â· ìê¸°ê³ ìš© Â· ìê¸°ì„¸ê³„", [0.95, 0.9, 0.95, 0.9]),
            ("ì§„ì·¨ì„±(ì„ ë„ì„±)", [0.95, 0.95, 0.95, 0.95]),
            ("ìœ„í—˜ê°ìˆ˜ì„±", [0.9, 0.9, 0.95, 0.95]),
            ("í˜ì‹ ì„±", [0.9, 0.95, 0.95])
        ], "í˜„ëŒ€ê·¸ë£¹ì„ ì¼êµ° ì •ì£¼ì˜ íšŒì¥ì€ ììœ¨ì„±, ë„ì „ì •ì‹ , ì‹¤í–‰ë ¥ ë“± ì „ë°©ìœ„ì  ì—­ëŸ‰ì—ì„œ ê³ ë£¨ ë›°ì–´ë‚œ ì¸ë¬¼ì…ë‹ˆë‹¤.")
    }

    competence_scores = {}
    if selected_name == "ì´ì¶˜ìš°":
        st.success("ğŸŒŸ ë‹¹ì‹ ì€ ì´ë¯¸ ì™„ì„±ëœ í†µí•©ëª¨í˜• ê·¸ ìì²´ë¥¼ ì…ë ¥í•˜ì…¨ìŠµë‹ˆë‹¤!")
        competence_scores = {k: 1.0 for k in [
            "ë„ì „ì •ì‹ ", "ìµœê³ Â·ìµœì´ˆÂ·ìµœì‹ Â·ìœ ì¼ ì§€í–¥", "Integrity", "ì°½ì¡°ì  ë¬¸ì œí•´ê²°",
            "ë…ë¦½ì„± Â· ìê¸°ê³ ìš© Â· ìê¸°ì„¸ê³„", "ì§„ì·¨ì„±(ì„ ë„ì„±)", "ìœ„í—˜ê°ìˆ˜ì„±", "í˜ì‹ ì„±"]}

    elif selected_name in sample_profiles:
        traits, comment = sample_profiles[selected_name]
        for bundle, values in traits:
            competence_scores[bundle] = np.mean(values)

        st.success(f"âœ… '{selected_name}'ì˜ ì—­ëŸ‰ í”„ë¡œíŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤")
        st.markdown(f"ğŸ’¬ **AI í‰ê°€ ì£¼ì„**: {comment}")

        with st.expander("ğŸ“Š í•˜ìœ„ ìš”ì†Œë³„ ì ìˆ˜ ë³´ê¸°"):
            for bundle, values in traits:
                st.markdown(f"**{bundle}**")
                for i, score in enumerate(values):
                    st.markdown(f"â€ƒâ€ƒ- í•˜ìœ„ ìš”ì†Œ {i+1}: {score:.2f}")

    else:
        st.info("âœï¸ ë¶„ì„í•  ì¸ë¬¼ì— ëŒ€í•œ ì„¸ë¶€ ì—­ëŸ‰ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”!")
        manual_traits = {
            "ğŸ’ª ë„ì „ì •ì‹ ": ["ìê¸°íš¨ëŠ¥ê° (self-efficacy), ìì‹ ê°", "ì„±ì·¨ ìš•êµ¬", "í—ê·¸ë¦¬ì •ì‹ , ëª©í‘œ ë‹¬ì„± ì¶”êµ¬"],
            "ğŸ’¡ ìµœê³ Â·ìµœì´ˆÂ·ìµœì‹ Â·ìœ ì¼ ì§€í–¥": ["ì—´ë§", "ì¶”ì§„ë ¥, ì‹¤í–‰ë ¥", "ê²°ë‹¨ë ¥", "ê³ ìˆ˜ìµ ê¸°ëŒ€"],
            "ğŸ§­ Integrity": ["ë¦¬ë”ì‹­", "ì‚¬ì—…ìˆ˜ì™„", "ê²½ì˜ ê´€ë¦¬ ì—­ëŸ‰", "ì‹ ìš©, ì‹ ë¢°", "ê·¼ë©´, ê²€ì†Œ, ì„±ì‹¤ì„±"],
            "ğŸ” ì°½ì¡°ì  ë¬¸ì œí•´ê²°": ["ê¸ì •ì„±", "í†µì°°ë ¥", "ì•„ì´ë””ì–´, ìƒìƒë ¥", "ì¸ì§€ ëŠ¥ë ¥"],
            "ğŸŒ± ë…ë¦½ì„± Â· ìê¸°ê³ ìš© Â· ìê¸°ì„¸ê³„": ["ìì•„ì‹¤í˜„", "ììœ¨ì„±", "ìˆœì‘ ê±°ë¶€", "ì—­ê²½ ê·¹ë³µ"],
            "ğŸš€ ì§„ì·¨ì„±(ì„ ë„ì„±)": ["ì—´ì •", "ëª¨í˜¸ì„± ì¸ë‚´ë„", "ê²½ìŸì  ê³µê²©ì„±", "ì„ ë„ë ¥"],
            "ğŸ›¡ ìœ„í—˜ê°ìˆ˜ì„±": ["ì¸ë‚´ì‹¬", "ìœ„í—˜ì„ í˜¸", "CSR/CSV", "ì±…ì„ê°"],
            "ğŸ”„ í˜ì‹ ì„±": ["ê¸°ì—…ìœ¤ë¦¬", "ì°½ì˜ì„±", "í˜ì‹  ìˆ˜ìš©"]
        }
        for bundle, items in manual_traits.items():
            st.markdown(f"### {bundle}")
            values = []
            for trait in items:
                score = st.slider(f"â€ƒâ€ƒ{trait}", 0.0, 1.0, 0.0, 0.01)
                values.append(score)
            clean_key = bundle.split(" ")[1] if " " in bundle else bundle
            competence_scores[clean_key] = np.mean(values)

    # ì ìˆ˜ ê³„ì‚° ë° ì‹œê°í™”
    def compute_bombi_score(scores):
        comp_to_att = {
            "ë„ì „ì •ì‹ ": ["ì°½ì¡° Â· ë°œëª… Â· ê°œë°œ", "ì¡°í•© Â· ì¤‘ê°œ"],
            "ìµœê³ Â·ìµœì´ˆÂ·ìµœì‹ Â·ìœ ì¼ ì§€í–¥": ["ì¡°í•© Â· ì¤‘ê°œ", "í˜ì‹  Â· ë³€í™” Â· ê°œì„ "],
            "Integrity": ["í˜ì‹  Â· ë³€í™” Â· ê°œì„ ", "ë„ì „ Â· ê·¹ë³µ"],
            "ì°½ì¡°ì  ë¬¸ì œí•´ê²°": ["ë„ì „ Â· ê·¹ë³µ", "ì£¼ë„ Â· ì‚¬ì—…í™”"],
            "ë…ë¦½ì„± Â· ìê¸°ê³ ìš© Â· ìê¸°ì„¸ê³„": ["ì£¼ë„ Â· ì‚¬ì—…í™”", "ì—­ë°œìƒ Â· ì¬í•´ì„"],
            "ì§„ì·¨ì„±(ì„ ë„ì„±)": ["ì—­ë°œìƒ Â· ì¬í•´ì„", "ê°œì²™ Â· íƒí—˜ Â· ëª¨í—˜"],
            "ìœ„í—˜ê°ìˆ˜ì„±": ["ê°œì²™ Â· íƒí—˜ Â· ëª¨í—˜", "ë°œê²¬ Â· ë°œìƒ Â· ìƒìƒ"],
            "í˜ì‹ ì„±": ["ë°œê²¬ Â· ë°œìƒ Â· ìƒìƒ", "ì°½ì¡° Â· ë°œëª… Â· ê°œë°œ"]
        }
        attitude = {k: 0.0 for v in comp_to_att.values() for k in v}
        for comp, val in scores.items():
            for att in comp_to_att[comp]:
                attitude[att] += val * 0.5
        attitude = {k: min(v, 1.0) for k, v in attitude.items()}

        att_to_mis = {
            "ì°½ì¡° Â· ë°œëª… Â· ê°œë°œ": {"ê¸°íšŒì¶”êµ¬": 0.25, "ë¯¸ë˜ì§€í–¥": 0.25},
            "ì¡°í•© Â· ì¤‘ê°œ": {"ê¸°íšŒì¶”êµ¬": 0.5},
            "í˜ì‹  Â· ë³€í™” Â· ê°œì„ ": {"ê¸°íšŒì¶”êµ¬": 0.25, "ê³µë™ì²´ ë°œì „": 0.25},
            "ë„ì „ Â· ê·¹ë³µ": {"ê³µë™ì²´ ë°œì „": 0.5},
            "ì£¼ë„ Â· ì‚¬ì—…í™”": {"ê³µë™ì²´ ë°œì „": 0.25, "ì°½ì¡°ì  íŒŒê´´": 0.25},
            "ì—­ë°œìƒ Â· ì¬í•´ì„": {"ì°½ì¡°ì  íŒŒê´´": 0.5},
            "ê°œì²™ Â· íƒí—˜ Â· ëª¨í—˜": {"ì°½ì¡°ì  íŒŒê´´": 0.25, "ë¯¸ë˜ì§€í–¥": 0.25},
            "ë°œê²¬ Â· ë°œìƒ Â· ìƒìƒ": {"ë¯¸ë˜ì§€í–¥": 0.5}
        }
        mission = {k: 0.0 for k in ["ê¸°íšŒì¶”êµ¬", "ê³µë™ì²´ ë°œì „", "ì°½ì¡°ì  íŒŒê´´", "ë¯¸ë˜ì§€í–¥"]}
        for att, val in attitude.items():
            for mis, w in att_to_mis.get(att, {}).items():
                mission[mis] += val * w
        mission = {k: min(v, 1.0) for k, v in mission.items()}
        outcome_score = np.mean(list(mission.values()))
        return outcome_score, attitude, mission

    if competence_scores:
        outcome, attitude, mission = compute_bombi_score(competence_scores)
        st.markdown("---")
        st.metric("ğŸŒŸ ìµœì¢… ë´„ë¹„ ì ìˆ˜", f"{round(outcome * 100, 2)} / 100")

        with st.expander("ğŸŒ€ íƒœë„ ë ˆì´ì–´ ì ìˆ˜ ë³´ê¸°"):
            st.json(attitude)

        with st.expander("ğŸ¯ ì‚¬ëª… ë ˆì´ì–´ ì ìˆ˜ ë³´ê¸°"):
            st.json(mission)

        st.markdown("---")
        st.subheader("ğŸ“ˆ ë ˆì´ë” ì°¨íŠ¸")
        fig = go.Figure()
        fig.add_trace(go.Scatterpolar(
            r=list(competence_scores.values()),
            theta=list(competence_scores.keys()),
            fill='toself',
            name='ì—­ëŸ‰ í”„ë¡œíŒŒì¼'
        ))
        fig.update_layout(polar=dict(radialaxis=dict(visible=True, range=[0, 1])), showlegend=False)
        st.plotly_chart(fig, use_container_width=True)